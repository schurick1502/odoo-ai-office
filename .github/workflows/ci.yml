name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install linters
        run: pip install ruff
      - name: Lint service
        run: ruff check service/
      - name: Lint addon
        run: ruff check odoo/addons/account_ai_office/
      - name: Lint MCP servers
        run: ruff check mcp_servers/

  test-service:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        working-directory: service
        run: pip install ".[dev]"
      - name: Run tests
        working-directory: service
        run: pytest -v --tb=short

  test-mcp:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        working-directory: mcp_servers
        run: pip install ".[dev]"
      - name: Run tests
        working-directory: mcp_servers
        run: pytest -v --tb=short

  build-service:
    runs-on: ubuntu-latest
    needs: test-service
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker image
        run: docker build -t ai-office-service:test ./service
